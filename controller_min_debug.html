<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller MIN DEBUG — Upload & Anteprima</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0c111a;color:#e9eef9;margin:0;padding:20px}
  .row{margin:10px 0;display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
  input,button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0b111b;color:#e9eef9}
  button{cursor:pointer}
  img{width:160px;height:200px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0a0f18}
  #status{font-size:12px;color:#cfe1ff;margin-top:8px}
  #players{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:18px}
  .card{background:#121826;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
  .name{font-weight:800;margin:6px 0}
</style>
</head>
<body>
  <h1>Controller MIN DEBUG</h1>
  <div class="row"><label>Nome</label><input id="name" placeholder="Es. Marco Rossi"></div>
  <div class="row"><label>ID (opz.)</label><input id="pid" placeholder="Se vuoto genero p_<ts>"></div>
  <div class="row"><label>File immagine</label><input type="file" id="file" accept="image/*"></div>
  <div class="row"><label>URL immagine</label><input id="url" placeholder="https://..."></div>
  <div class="row"><label>Anteprima</label><img id="preview" alt="preview"></div>
  <div class="row"><label></label>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnPreview">Anteprima</button>
      <button id="btnSave">Carica/Salva</button>
      <button id="btnReload">Ricarica roster</button>
    </div>
  </div>
  <div id="status"></div>
  <progress id="prog" value="0" max="100" style="width:100%;display:none"></progress>

  <h2>Roster Live</h2>
  <div id="players"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // >>> SOSTITUISCI QUI con la TUA CONFIG <<<
  const firebaseConfig = {
  apiKey: "AIzaSyD4yelGFXgB520udav97oM2gGQkRd9gKYk",
  authDomain: "roster-55059.firebaseapp.com",
  databaseURL: "https://roster-55059-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "roster-55059",
  storageBucket: "roster-55059.firebasestorage.app",
  messagingSenderId: "689419688801",
  appId: "1:689419688801:web:edf1d12948281a77fb0320"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const $ = s => document.querySelector(s);
    const nameEl = $('#name'), pidEl = $('#pid'), fileEl = $('#file'), urlEl = $('#url');
    const preview = $('#preview'), statusEl = $('#status'), prog = $('#prog'), players = $('#players');

    function setStatus(t){ statusEl.textContent = t || ''; console.log('[STATUS]', t); }

    $('#btnPreview').onclick = () => {
      const file = fileEl.files && fileEl.files[0];
      const url = urlEl.value.trim();
      if(file){
        const rd = new FileReader();
        rd.onload = e => preview.src = e.target.result;
        rd.readAsDataURL(file);
        setStatus('Anteprima da file');
      } else if(url){
        preview.src = url;
        setStatus('Anteprima da URL');
      } else {
        preview.removeAttribute('src'); setStatus('Nessuna immagine');
      }
    };

    async function savePlayer(){
      try{
        const name = nameEl.value.trim();
        if(!name){ alert('Nome obbligatorio'); return; }
        let id = pidEl.value.trim() || ('p_'+Date.now());
        let imgUrl = urlEl.value.trim();
        const file = fileEl.files && fileEl.files[0];

        if(!imgUrl && file){
          const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
          const ref = storage.ref().child('players/'+id+'.'+ext);
          const meta = { contentType: file.type || 'image/jpeg', cacheControl:'public,max-age=604800' };
          setStatus('Upload in corso…'); prog.style.display='block';
          const task = ref.put(file, meta);
          await new Promise((res,rej)=>task.on('state_changed',
            s=>{ prog.value = Math.round((s.bytesTransferred/s.totalBytes)*100); },
            rej, res
          ));
          imgUrl = await ref.getDownloadURL();
          setStatus('Upload OK');
        }

        if(!imgUrl){ alert('Seleziona file o URL'); return; }

        const updatedAt = Date.now();
        await db.ref('/roster/'+id).set({ name, img: imgUrl, updatedAt });
        setStatus('Salvato su DB: '+id);
        await reloadRoster();
      } catch(e){
        console.error(e);
        alert('ERRORE: '+(e && e.message ? e.message : e));
        setStatus('Errore: '+(e && e.message ? e.message : e));
      } finally {
        setTimeout(()=>prog.style.display='none', 800);
      }
    }
    $('#btnSave').onclick = savePlayer;

    async function reloadRoster(){
      const snap = await db.ref('/roster').get();
      const r = snap.exists() ? snap.val() : {};
      players.innerHTML = '';
      Object.entries(r).forEach(([id,p])=>{
        const url = p.img + (p.updatedAt ? (p.img.includes('?')?'&':'?')+'v='+p.updatedAt : '');
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = '<img src="'+url+'" alt="'+(p.name||'')+'" onerror="this.style.opacity=0.4;"><div class="name">'+(p.name||'')+'</div><div style="font-size:12px;opacity:.7">'+id+'</div>';
        players.appendChild(card);
      });
      setStatus('Roster ricaricato ('+Object.keys(r).length+' giocatori)');
    }
    $('#btnReload').onclick = reloadRoster;

    // live update
    db.ref('/roster').on('value', ()=>reloadRoster());

    // hint iniziale
    setStatus('Pronto. Fai Anteprima, poi Carica/Salva.');
  </script>
</body>
</html>
