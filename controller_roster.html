<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controller Roster — GitHub • Lineup • Roller • Cambi</title>
<style>
  :root{
    --bg:#0c111a; --panel:#121826; --muted:#a6b7d2; --accent:#39d5ff; --danger:#ff5575; --ok:#78ffb3;
  }
  html, body{ margin:0; padding:0; background:var(--bg); color:#e9eef9; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
  header{ padding:14px 16px; background:#0f1522; border-bottom:1px solid rgba(255,255,255,.08); }
  h1{ margin:0; font-size:18px; letter-spacing:.3px; }
  .wrap{ padding:14px; display:grid; gap:14px; grid-template-columns:1fr 1fr; }
  .card{ background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; }
  .card h2{ margin:0 0 8px; font-size:16px; }
  .row{ display:grid; grid-template-columns:2fr 2fr 2fr 2fr; gap:8px; }
  label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0b111b; color:#e9eef9; }
  .btn{ padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0d1624; color:#e9eef9; cursor:pointer; font-size:15px; }
  .btn:hover{ filter:brightness(1.08); }
  .btn-accent{ background:var(--accent); color:#001018; font-weight:800; }
  .btn-danger{ background:var(--danger); color:#2c0009; font-weight:800; }
  .btn-ok{ background:var(--ok); color:#00140a; font-weight:800; }
  .tiny{ font-size:12px; color:var(--muted); }
  .bar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  .players{ display:grid; gap:10px; max-height:60vh; overflow:auto; padding-right:6px; }
  .player{ display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px; padding:10px; background:#0c1422; border:1px solid rgba(255,255,255,.06); border-radius:10px; }
  .player img{ width:64px; height:80px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0a0f18; }
  .name{ font-weight:700; font-size:16px; }
  input[type="checkbox"]{ width:24px; height:24px; }

  /* Ordine Roller + Drag & Drop */
  .order{ display:grid; gap:8px; max-height:45vh; overflow:auto; }
  .order-item{ display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px; padding:10px; background:#0c1422; border:1px solid rgba(255,255,255,.06); border-radius:10px; cursor:grab; }
  .order-item:active{ cursor:grabbing; }
  .order-item img{ width:48px; height:60px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); }
  .order-item.dragging{ opacity:.6; outline:2px dashed rgba(57,213,255,.6); }
  .order-drop-hint{ height:8px; margin:4px 0; border-radius:8px; background:rgba(57,213,255,.6); }

  /* Cambi */
  .subs-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
  select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0b111b; color:#e9eef9; }
  .sub-preview{ display:grid; justify-items:center; gap:6px; }
  .sub-preview img{ width:120px; height:150px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0a0f18; }

  @media (max-width: 980px){
    .wrap{ grid-template-columns:1fr; }
    .row{ grid-template-columns:1fr 1fr; }
    .player img{ width:84px; height:104px; }
    .btn{ padding:14px 16px; font-size:17px; }
    input[type="checkbox"]{ width:28px; height:28px; }
    .subs-grid{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
  <header><h1>Controller Roster — GitHub • Lineup • Roller • Cambi</h1></header>

  <div class="wrap">
    <!-- Sorgente GitHub -->
    <section class="card">
      <h2>Sorgente GitHub</h2>
      <div class="row">
        <div>
          <label>Owner / Utente</label>
          <input type="text" id="ghOwner" value="rflbrescia-netizen" />
        </div>
        <div>
          <label>Repository</label>
          <input type="text" id="ghRepo" value="roster" />
        </div>
        <div>
          <label>Cartella (opz.)</label>
          <input type="text" id="ghPath" value="" placeholder="es. players" />
        </div>
        <div>
          <label>Token GitHub (opz.)</label>
          <input type="text" id="ghToken" placeholder="PAT per repo private o rate limit" />
        </div>
      </div>
      <div class="bar" style="margin-top:8px;">
        <button class="btn btn-accent" id="scan">Scansiona repo</button>
        <button class="btn" id="btnSelAll">Seleziona tutto</button>
        <button class="btn" id="btnClearSel">Pulisci selezione</button>
        <span id="status" class="tiny"></span>
      </div>
      <p class="tiny">Estensioni supportate: <code>.jpg .jpeg .png .webp</code>. I nomi sono ricavati dal filename.</p>
    </section>

    <!-- Comandi Overlay -->
    <section class="card">
      <h2>Comandi Overlay</h2>
      <div class="bar" style="margin-bottom:8px;">
        <button class="btn btn-accent" id="btnRoller">Roster Roller</button>
        <button class="btn" id="btnLineup">Invia lineup</button>
        <button class="btn" id="btnStop">Stop / Idle</button>
      </div>
      <p class="tiny">• Roller: sequenza a sinistra (4s). • Lineup: selezionati per 5s. • Stop: pulisci overlay.</p>
    </section>

    <!-- Roster -->
    <section class="card" style="grid-column: 1 / span 2;">
      <h2>Giocatori</h2>
      <div id="players" class="players"></div>
    </section>

    <!-- Ordine Roller -->
    <section class="card" style="grid-column: 1 / span 2;">
      <h2>Ordine Roster Roller</h2>
      <div class="tiny">Trascina per riordinare; ↑/↓ come fallback; premi <b>Salva ordine</b> per inviare all’overlay.</div>
      <div id="orderList" class="order" style="margin-top:8px;"></div>
      <div class="bar" style="margin-top:8px;">
        <button class="btn btn-ok" id="saveOrder">Salva ordine</button>
        <button class="btn" id="resetOrder">Reset ordine</button>
      </div>
    </section>

    <!-- Cambi (Entrante/Uscente) -->
    <section class="card" style="grid-column: 1 / span 2;">
      <h2>Cambio giocatore</h2>
      <div class="subs-grid">
        <div>
          <label>Giocatore Entrante</label>
          <select id="subIn"></select>
          <div class="sub-preview">
            <img id="subInImg" alt="Entrante">
            <div id="subInName" class="tiny"></div>
          </div>
        </div>
        <div>
          <label>Giocatore Uscente</label>
          <select id="subOut"></select>
          <div class="sub-preview">
            <img id="subOutImg" alt="Uscente">
            <div id="subOutName" class="tiny"></div>
          </div>
        </div>
      </div>
      <div class="bar" style="margin-top:10px;">
        <button class="btn btn-accent" id="btnSendSub">Invia Cambio</button>
        <span class="tiny">Durata 2000ms • l’overlay mostra un IN/OUT chiaro e veloce.</span>
      </div>
    </section>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
/* ===== Firebase CONFIG (quella del tuo file) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAyVKKlQTXIuSzxrm_2mATvQR1QjUvtRA8",
  authDomain: "roster-dinamico-esordienti.firebaseapp.com",
  projectId: "roster-dinamico-esordienti",
  storageBucket: "roster-dinamico-esordienti.appspot.com",
  messagingSenderId: "6424935938",
  appId: "1:6424935938:web:97c30f6f758fafad9eb11b",
  databaseURL: "https://roster-dinamico-esordienti-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== Helpers DOM ===== */
const $ = (s)=>document.querySelector(s);
const playersEl = $('#players');
const statusEl  = $('#status');
const orderEl   = $('#orderList');
const subInSel  = $('#subIn');
const subOutSel = $('#subOut');
const subInImg  = $('#subInImg');
const subOutImg = $('#subOutImg');
const subInName = $('#subInName');
const subOutName= $('#subOutName');

/* ===== Bind UI ===== */
$('#scan').onclick        = scanRepo;
$('#btnRoller').onclick   = triggerRoller;
$('#btnLineup').onclick   = sendLineup;
$('#btnStop').onclick     = setIdle;
$('#btnSelAll').onclick   = () => setAllChecks(true);
$('#btnClearSel').onclick = () => setAllChecks(false);
$('#saveOrder').onclick   = saveOrder;
$('#resetOrder').onclick  = resetOrder;
$('#btnSendSub').onclick  = sendSub;

/* ===== Live sync roster ===== */
let liveRoster = {};
db.ref('/roster').on('value', snap => {
  liveRoster = snap.val() || {};
  renderRoster(liveRoster);
  renderOrder(liveRoster);
  renderSubsSelectors(liveRoster);
});

/* ===== GitHub → /roster ===== */
function scanRepo(){
  const owner = $('#ghOwner').value.trim();
  const repo  = $('#ghRepo').value.trim();
  const path  = $('#ghPath').value.trim().replace(/^\/+|\/+$/g,'');
  const token = $('#ghToken').value.trim();
  if(!owner || !repo){ alert('Inserisci owner e repo.'); return; }

  const base = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents`;
  const api  = path ? `${base}/${encodeURIComponent(path)}` : base;

  statusEl.textContent = 'Scansiono repository...';
  const headers = { 'Accept':'application/vnd.github+json' };
  if(token){ headers['Authorization'] = 'Bearer ' + token; }

  fetch(api, { cache:'no-store', headers })
    .then(res => {
      if(!res.ok) return res.text().then(t => { throw new Error(`GitHub API HTTP ${res.status} — ${t.slice(0,180)}`); });
      return res.json();
    })
    .then(items => {
      if(!Array.isArray(items)) throw new Error('Risposta inattesa: non è una lista');
      const exts = ['.jpg','.jpeg','.png','.webp'];
      const images = items.filter(x => {
        const nm = (x && x.name ? x.name.toLowerCase() : '');
        return x && x.type==='file' && exts.some(ext => nm.endsWith(ext));
      });
      if(!images.length){ statusEl.textContent = 'Nessuna immagine trovata nella cartella indicata.'; return; }

      const normalized = {};
      const now = Date.now();
      images.forEach(file => {
        const nameGuess = prettyName(file.name);
        const id = genId(nameGuess);
        const imgUrl = file.download_url ? file.download_url : toRaw(owner, repo, path, file.name);
        normalized[id] = { name: nameGuess, img: imgUrl, updatedAt: now };
      });

      return db.ref('/roster').set(normalized).then(() => {
        statusEl.textContent = `Importati ${images.length} giocatori da GitHub.`;
      });
    })
    .catch(e => {
      console.error(e);
      statusEl.textContent = 'Errore: ' + (e && e.message ? e.message : e);
      alert('Errore durante la scansione: ' + (e && e.message ? e.message : e));
    });
}

/* ===== Render Roster ===== */
function renderRoster(roster){
  playersEl.innerHTML = '';
  Object.keys(roster).forEach(id => {
    const p = roster[id] || {};
    const cacheBust = p.img ? p.img + (p.img.includes('?') ? '&' : '?') + 'v=' + (p.updatedAt||0) : '';
    const row = document.createElement('div');
    row.className = 'player';
    row.innerHTML =
      `<img src="${cacheBust}" alt="${p.name||''}" onerror="this.style.opacity=0.4">
       <div>
         <div class="name">${p.name||''}</div>
         <label class="tiny"><input type="checkbox" data-id="${id}" class="pickLineup"> Includi in lineup</label>
       </div>
       <button class="btn" data-id="${id}" data-action="flash">Flash 2s</button>
       <span class="tiny">${id}</span>`;
    row.querySelector('[data-action="flash"]').onclick = () => flashPlayer(id);
    playersEl.appendChild(row);
  });
}
function setAllChecks(val){
  document.querySelectorAll('.pickLineup').forEach(el => el.checked = !!val);
}

/* ===== Roller order UI (Drag & Drop + ↑/↓) ===== */
function renderOrder(roster){
  orderEl.innerHTML = '';
  const ids = Object.keys(roster);
  ids.forEach((id, idx) => {
    const p = roster[id]; if (!p) return;
    const row = document.createElement('div');
    row.className  = 'order-item';
    row.dataset.id = id;
    row.draggable  = true;
    row.innerHTML =
      `<img src="${p.img}" alt="${p.name||''}">
       <div class="name">${p.name||''}</div>
       <button class="btn" data-idx="${idx}" data-act="up">↑</button>
       <button class="btn" data-idx="${idx}" data-act="down">↓</button>`;
    row.querySelector('[data-act="up"]').onclick   = () => moveOrder(idx, -1);
    row.querySelector('[data-act="down"]').onclick = () => moveOrder(idx, +1);
    addDnDHandlers(row);
    orderEl.appendChild(row);
  });
  orderEl.addEventListener('dragover', onDragOverContainer);
  orderEl.addEventListener('drop', onDropContainer);
}
function currentOrderFromDOM(){
  return Array.from(orderEl.querySelectorAll('.order-item'))
              .map(row => row.dataset.id);
}
function moveOrder(index, dir){
  const ids = currentOrderFromDOM();
  const j = index + dir;
  if (j < 0 || j >= ids.length) return;
  [ids[index], ids[j]] = [ids[j], ids[index]];
  const reordered = {};
  ids.forEach(id => { if (liveRoster[id]) reordered[id] = liveRoster[id]; });
  renderOrder(reordered);
}
function saveOrder(){
  try{
    const idsVisible = currentOrderFromDOM();
    db.ref('/roller/order').set(idsVisible);
    alert('Ordine salvato.');
  }catch(e){
    console.error(e);
    alert('Errore salvataggio ordine: ' + (e.message || e));
  }
}
function resetOrder(){
  const ids = Object.keys(liveRoster);
  db.ref('/roller/order').set(ids);
  renderOrder(liveRoster);
}

/* ----- DnD helpers ----- */
let draggedEl = null;
let dropHintEl = null;
function addDnDHandlers(el){
  el.addEventListener('dragstart', (e)=>{
    draggedEl = el; el.classList.add('dragging');
    if (e.dataTransfer) { e.dataTransfer.effectAllowed = 'move'; try { e.dataTransfer.setData('text/plain', el.dataset.id); } catch(_) {} }
  });
  el.addEventListener('dragend', ()=>{
    if (draggedEl) draggedEl.classList.remove('dragging');
    draggedEl = null; removeDropHint();
  });
  el.addEventListener('dragover', (e)=>{
    e.preventDefault(); e.dataTransfer && (e.dataTransfer.dropEffect = 'move');
    insertDropHint(el, e.clientY);
  });
  el.addEventListener('drop', (e)=>{
    e.preventDefault(); if (!draggedEl || draggedEl === el) return; commitDrop(el, e.clientY);
  });
}
function onDragOverContainer(e){
  e.preventDefault(); e.dataTransfer && (e.dataTransfer.dropEffect = 'move');
  if (!e.target.closest('.order-item') && draggedEl) insertDropHint(null, null, true);
}
function onDropContainer(e){
  e.preventDefault(); if (!draggedEl) return;
  const targetRow = e.target.closest('.order-item');
  if (targetRow) commitDrop(targetRow, e.clientY); else commitDrop(null, null, true);
}
function insertDropHint(targetRow, clientY, atEnd=false){
  if (!dropHintEl){ dropHintEl = document.createElement('div'); dropHintEl.className = 'order-drop-hint'; }
  if (atEnd || !targetRow){ orderEl.appendChild(dropHintEl); return; }
  const box = targetRow.getBoundingClientRect();
  const before = clientY < box.top + box.height/2;
  if (before) orderEl.insertBefore(dropHintEl, targetRow); else orderEl.insertBefore(dropHintEl, targetRow.nextSibling);
}
function removeDropHint(){ if (dropHintEl && dropHintEl.parentNode) dropHintEl.parentNode.removeChild(dropHintEl); dropHintEl = null; }
function commitDrop(targetRow, clientY, atEnd=false){
  if (!draggedEl) return;
  if (dropHintEl){ orderEl.insertBefore(draggedEl, dropHintEl); }
  else if (targetRow){
    const box = targetRow.getBoundingClientRect(); const before = clientY < box.top + box.height/2;
    orderEl.insertBefore(draggedEl, before ? targetRow : targetRow.nextSibling);
  } else if (atEnd){ orderEl.appendChild(draggedEl); }
  removeDropHint(); draggedEl.classList.remove('dragging');
  const ids = currentOrderFromDOM(); const reordered = {};
  ids.forEach(id => { if (liveRoster[id]) reordered[id] = liveRoster[id]; });
  renderOrder(reordered);
  // Auto-save? Decommenta la riga sotto se vuoi salvare ogni drop:
  // db.ref('/roller/order').set(ids);
}

/* ===== Cambi (Entrante/Uscente) ===== */
function renderSubsSelectors(roster){
  const entries = Object.entries(roster);
  const buildOpts = (sel) => {
    sel.innerHTML = '<option value="">— seleziona —</option>' + entries.map(([id,p])=>(
      `<option value="${id}" data-img="${p.img}">${p.name||id}</option>`
    )).join('');
  };
  buildOpts(subInSel); buildOpts(subOutSel);
  const updatePreview = () => {
    const inId  = subInSel.value,  outId = subOutSel.value;
    if (inId && liveRoster[inId])  { subInImg.src  = liveRoster[inId].img;  subInName.textContent  = liveRoster[inId].name||inId; }
    else { subInImg.removeAttribute('src'); subInName.textContent=''; }
    if (outId && liveRoster[outId]){ subOutImg.src = liveRoster[outId].img; subOutName.textContent = liveRoster[outId].name||outId; }
    else { subOutImg.removeAttribute('src'); subOutName.textContent=''; }
  };
  subInSel.onchange = updatePreview;
  subOutSel.onchange= updatePreview;
  updatePreview();
}
function sendSub(){
  const inId  = subInSel.value.trim();
  const outId = subOutSel.value.trim();
  if(!inId || !outId){ alert('Seleziona Entrante e Uscente.'); return; }
  if(inId === outId){ alert('Entrante e Uscente devono essere diversi.'); return; }
  db.ref('/mode').set('subs').then(()=>{
    db.ref('/subs/show').set({ inId, outId, ttl: 2000, nonce: Date.now() });
  });
}

/* ===== Overlay commands ===== */
function triggerRoller(){
  db.ref('/mode').set('roller').then(()=>db.ref('/roller/start').set(Date.now()));
}
function sendLineup(){
  const picks = Array.from(document.querySelectorAll('.pickLineup:checked')).map(el => el.getAttribute('data-id'));
  if(!picks.length){ alert('Seleziona almeno un giocatore.'); return; }
  db.ref('/mode').set('lineup').then(()=>{
    db.ref('/lineup/show').set({ playerIds: picks, ttl: 5000, nonce: Date.now() });
  });
}
function setIdle(){
  db.ref('/mode').set('idle');
  db.ref('/lineup/show').set(null);
  db.ref('/flash/show').set(null);
  db.ref('/roller/start').set(null);
  db.ref('/subs/show').set(null);
}
function flashPlayer(playerId){
  db.ref('/mode').set('flash').then(()=>{
    db.ref('/flash/show').set({ playerId, ttl: 2000, nonce: Date.now() });
  });
}

/* ===== Utils ===== */
function toRaw(owner, repo, path, name){
  const p = path ? (path.replace(/^\/+|\/+$/g,'') + '/') : '';
  return `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${p}${name}`;
}
function prettyName(filename){
  const base = filename.replace(/\.[^.]+$/, '');
  const spaced = base.replace(/[_\-\.]+/g, ' ').trim();
  return spaced.split(' ').map(w => w ? (w[0].toUpperCase()+w.slice(1).toLowerCase()) : '').join(' ').trim();
}
function genId(name){
  const base = String(name).toLowerCase()
               .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
               .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  return base + '-' + Math.random().toString(36).slice(2,6);
}
  </script>
</body>
</html>
