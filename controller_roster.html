<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controller Roster (GitHub Images - FIX)</title>
<style>
  :root {
    --bg: #0c111a;
    --panel: #121826;
    --muted: #a6b7d2;
    --accent: #39d5ff;
    --danger: #ff5575;
  }
  html, body { margin:0; padding:0; background:var(--bg); color:#e9eef9; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; }
  header { padding:14px 16px; background:#0f1522; border-bottom:1px solid rgba(255,255,255,.08); }
  h1 { margin:0; font-size:18px; letter-spacing:.3px; }
  .wrap { padding:14px; display:grid; gap:14px; grid-template-columns:1fr 1fr; }
  .card { background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px; }
  .card h2 { margin:0 0 8px; font-size:16px; }
  .row { display:grid; grid-template-columns: 2fr 2fr 2fr 2fr; gap:8px; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input[type="text"] { width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0b111b; color:#e9eef9; }
  .btn { padding:9px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0d1624; color:#e9eef9; cursor:pointer; }
  .btn:hover { filter:brightness(1.08); }
  .btn-accent { background:var(--accent); color:#001018; font-weight:800; }
  .btn-danger { background:var(--danger); color:#2c0009; font-weight:800; }
  .tiny { font-size:12px; color:var(--muted); }
  .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .players { display:grid; gap:8px; max-height:60vh; overflow:auto; padding-right:6px; }
  .player { display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px; padding:8px; background:#0c1422; border:1px solid rgba(255,255,255,.06); border-radius:10px; }
  .player img { width:48px; height:60px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); background:#0a0f18; }
  .name { font-weight:700; }
  #status { margin-left:8px; }
  .hint { margin-top:6px; }
  code { background:#0b111b; padding:2px 6px; border-radius:6px; }
</style>
</head>
<body>
  <header>
    <h1>Controller Roster — Carica da GitHub (solo foto, FIX)</h1>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>Sorgente GitHub</h2>
      <div class="row">
        <div>
          <label>Owner / Utente</label>
          <input type="text" id="ghOwner" value="rflbrescia-netizen" />
        </div>
        <div>
          <label>Repository</label>
          <input type="text" id="ghRepo" value="roster" />
        </div>
        <div>
          <label>Cartella (opz.)</label>
          <input type="text" id="ghPath" value="" placeholder="es. players" />
        </div>
        <div>
          <label>Token GitHub (opz.)</label>
          <input type="text" id="ghToken" placeholder="PAT per repo private o rate limit" />
        </div>
      </div>
      <div class="bar" style="margin-top:8px;">
        <button class="btn btn-accent" id="scan">Scansiona repo</button>
        <span id="status" class="tiny"></span>
      </div>
      <p class="tiny hint">
        Estensioni supportate: <code>.jpg .jpeg .png .webp</code>. I nomi sono ricavati dal filename.
      </p>
    </section>

    <section class="card">
      <h2>Comandi Overlay</h2>
      <div class="bar" style="margin-bottom:8px;">
        <button class="btn btn-accent" id="btnRoller">Roster Roller</button>
        <button class="btn" id="btnLineup">Invia lineup</button>
        <button class="btn btn-danger" id="btnStop">Stop / Idle</button>
      </div>
      <p class="tiny">• Roster Roller: sequenza a sinistra (4s ciascuno). • Invia lineup: selezionati per 5s. • Stop: pulisci.</p>
    </section>

    <section class="card" style="grid-column: 1 / span 2;">
      <h2>Giocatori</h2>
      <div id="players" class="players"></div>
    </section>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Config Firebase
    // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD4yelGFXgB520udav97oM2gGQkRd9gKYk",
  authDomain: "roster-55059.firebaseapp.com",
  databaseURL: "https://roster-55059-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "roster-55059",
  storageBucket: "roster-55059.firebasestorage.app",
  messagingSenderId: "689419688801",
  appId: "1:689419688801:web:edf1d12948281a77fb0320"
};
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helpers DOM
    function $(sel){ return document.querySelector(sel); }
    var playersEl = $('#players');
    var statusEl = $('#status');

    $('#scan').onclick = scanRepo;
    $('#btnRoller').onclick = triggerRoller;
    $('#btnLineup').onclick = sendLineup;
    $('#btnStop').onclick = function(){ setIdle(); };

    // Sync roster view
    db.ref('/roster').on('value', function(snap){
      var roster = snap.val() || {};
      renderRoster(roster);
    });

    function scanRepo(){
      var owner = $('#ghOwner').value.trim();
      var repo  = $('#ghRepo').value.trim();
      var path  = $('#ghPath').value.trim().replace(/^\/+|\/+$/g,'');
      var token = $('#ghToken').value.trim();
      if(!owner || !repo){ alert('Inserisci owner e repo.'); return; }

      var base = "https://api.github.com/repos/" + encodeURIComponent(owner) + "/" + encodeURIComponent(repo) + "/contents";
      var api  = path ? (base + "/" + encodeURIComponent(path)) : base;

      statusEl.textContent = "Scansiono repository...";
      var headers = { "Accept": "application/vnd.github+json" };
      if(token){ headers["Authorization"] = "Bearer " + token; }

      fetch(api, { cache: "no-store", headers: headers })
        .then(function(res){
          if(!res.ok){ return res.text().then(function(t){ throw new Error("GitHub API HTTP " + res.status + " — " + t.slice(0,180)); }); }
          return res.json();
        })
        .then(function(items){
          if(!Array.isArray(items)){ throw new Error("Risposta inattesa: non è una lista"); }
          var exts = [".jpg",".jpeg",".png",".webp"];
          var images = items.filter(function(x){
            var nm = (x && x.name ? x.name.toLowerCase() : "");
            return x && x.type === "file" && exts.some(function(ext){ return nm.endsWith(ext); });
          });
          if(!images.length){
            statusEl.textContent = "Nessuna immagine trovata nella cartella indicata.";
            return;
          }
          var normalized = {};
          images.forEach(function(file){
            var nameGuess = prettyName(file.name);
            var id = genId(nameGuess);
            var imgUrl = (file.download_url ? file.download_url : toRaw(owner, repo, path, file.name));
            normalized[id] = { name: nameGuess, img: imgUrl };
          });
          return db.ref("/roster").set(normalized).then(function(){
            statusEl.textContent = "Importati " + images.length + " giocatori da GitHub.";
          });
        })
        .catch(function(e){
          console.error(e);
          statusEl.textContent = "Errore: " + (e && e.message ? e.message : e);
          alert("Errore durante la scansione: " + (e && e.message ? e.message : e));
        });
    }

    function renderRoster(roster){
      playersEl.innerHTML = "";
      Object.keys(roster).forEach(function(id){
        var p = roster[id] || {};
        var row = document.createElement("div");
        row.className = "player";
        row.innerHTML =
          '<img src="' + (p.img||"") + '" alt="' + (p.name||"") + '">' +
          '<div>' +
            '<div class="name">' + (p.name||"") + '</div>' +
            '<label class="tiny"><input type="checkbox" data-id="' + id + '" class="pickLineup"> Includi in lineup</label>' +
          '</div>' +
          '<button class="btn" data-id="' + id + '" data-action="flash">Flash 2s</button>' +
          '<span class="tiny">' + id + '</span>';

        row.querySelector('[data-action="flash"]').onclick = function(){ flashPlayer(id); };
        playersEl.appendChild(row);
      });
    }

    // Mode commands
    function triggerRoller(){
      db.ref("/mode").set("roller").then(function(){
        db.ref("/roller/start").set(Date.now());
      });
    }
    function sendLineup(){
      var picks = Array.prototype.slice.call(document.querySelectorAll(".pickLineup:checked"))
                    .map(function(el){ return el.getAttribute("data-id"); });
      if(!picks.length){ alert("Seleziona almeno un giocatore."); return; }
      db.ref("/mode").set("lineup").then(function(){
        db.ref("/lineup/show").set({ playerIds: picks, ttl: 5000, nonce: Date.now() });
      });
    }
    function setIdle(){
      db.ref("/mode").set("idle");
      db.ref("/lineup/show").set(null);
      db.ref("/flash/show").set(null);
      db.ref("/roller/start").set(null);
    }
    function flashPlayer(playerId){
      db.ref("/mode").set("flash").then(function(){
        db.ref("/flash/show").set({ playerId: playerId, ttl: 2000, nonce: Date.now() });
      });
    }

    // Utils
    function toRaw(owner, repo, path, name){
      var p = path ? (path.replace(/^\/+|\/+$/g,'') + "/") : "";
      return "https://raw.githubusercontent.com/" + owner + "/" + repo + "/HEAD/" + p + name;
    }
    function prettyName(filename){
      var base = filename.replace(/\.[^.]+$/, "");
      var spaced = base.replace(/[_\-\.]+/g, " ").trim();
      return spaced.split(" ").map(function(w){
        if(!w) return "";
        return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
      }).join(" ").trim();
    }
    function genId(name){
      var base = String(name).toLowerCase()
                 .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
                 .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
      return base + "-" + Math.random().toString(36).slice(2,6);
    }
  </script>
</body>
</html>
