<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controller Roster (Upload Fix + Settings)</title>
<style>
  :root { --bg:#0c111a; --panel:#121826; --muted:#a6b7d2; --accent:#39d5ff; --ok:#78ffb3; --danger:#ff5575; }
  html, body { margin:0; padding:0; background:var(--bg); color:#e9eef9; font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; }
  header { padding:14px 16px; background:linear-gradient(180deg,#0f1522,#0b1019); border-bottom:1px solid rgba(255,255,255,.06); }
  h1 { margin:0; font-size:18px; letter-spacing:.3px; }
  .wrap { padding: 14px; display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
  .card { background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:14px; box-shadow:0 8px 22px rgba(0,0,0,.35); }
  .card h2 { margin:0 0 10px; font-size:16px; }
  .tiny { font-size:12px; color:var(--muted); }
  .bar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .btn { padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0d1624; color:#e9eef9; cursor:pointer; font-size:15px; }
  .btn:hover{ filter:brightness(1.08); }
  .btn-accent{ background:var(--accent); color:#001018; font-weight:800; }
  .btn-ok{ background:var(--ok); color:#00140a; font-weight:800; }
  .btn-danger{ background:var(--danger); color:#2c0009; font-weight:800; }
  input[type="text"], input[type="url"], input[type="number"], input[type="range"], input[type="file"], select {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0b111b; color:#e9eef9; outline:none;
  }
  progress { width:100%; height:10px; border-radius:999px; }
  .status { font-size:12px; color:#cfe1ff; }
  .players { display:grid; gap:10px; max-height:60vh; overflow:auto; padding-right:6px; }
  .player { display:grid; grid-template-columns:auto 1fr auto auto auto; align-items:center; gap:12px; padding:12px; border-radius:12px; background:#0c1422; border:1px solid rgba(255,255,255,.06); }
  .player img { width:76px; height:96px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0a0f18; }
  .name { font-weight:800; font-size:18px; }
  input[type="checkbox"]{ width:24px; height:24px; }
  .order { display:grid; gap:8px; max-height:50vh; overflow:auto; }
  .order-item{ display:grid; grid-template-columns:auto 1fr auto auto; align-items:center; gap:10px; padding:10px; background:#0c1422; border:1px solid rgba(255,255,255,.06); border-radius:10px; }
  .order-item img{ width:54px; height:68px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); }
  .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px; }
  .thumb { background:#0c1422; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:8px; display:grid; gap:8px; }
  .thumb img{ width:100%; height:140px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); }
  .two { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } .two{ grid-template-columns:1fr; } .player img { width:96px; height:120px; } .btn{ padding:14px 16px; font-size:17px; } input[type="checkbox"]{ width:28px; height:28px; } }
</style>
</head>
<body>
  <header><h1>Controller Roster — Upload Fix</h1></header>
  <div class="wrap">
    <section class="card">
      <h2>Comandi Overlay</h2>
      <div class="bar" style="margin-bottom:10px;">
        <button class="btn btn-accent" id="btnRoller">Roster Roller</button>
        <button class="btn" id="btnLineup">Invia lineup</button>
        <button class="btn btn-ok" id="btnSubs">Modalità Cambi</button>
        <button class="btn btn-danger" id="btnStop">Stop / Idle</button>
        <button class="btn" id="btnClearSel">Clear selezione</button>
      </div>
      <p class="tiny">Usa i settaggi e i bottoni per pilotare l'overlay.</p>
    </section>

    <section class="card">
      <h2>Roster</h2>
      <div id="players" class="players"></div>
    </section>

    <section class="card">
      <h2>Gestione Giocatori (nome + foto)</h2>
      <div class="two">
        <div>
          <label class="tiny">Nome giocatore</label>
          <input type="text" id="playerName" placeholder="Es. Marco Rossi">
        </div>
        <div>
          <label class="tiny">ID giocatore (opzionale)</label>
          <input type="text" id="playerId" placeholder="Se vuoto, sarà generato">
        </div>
        <div>
          <label class="tiny">Carica foto (file locale)</label>
          <input type="file" id="playerFile" accept="image/*">
        </div>
        <div>
          <label class="tiny">oppure URL immagine</label>
          <input type="url" id="playerUrl" placeholder="https://...">
        </div>
      </div>
      <div class="bar" style="margin-top:10px;">
        <button class="btn btn-accent" id="uploadPlayer">Carica/Salva giocatore</button>
        <button class="btn" id="clearForm">Pulisci form</button>
      </div>
      <div class="status" id="uploadStatus"></div>
      <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>
      <p class="tiny">Se carichi un file, sarà inviato su Firebase Storage e verrà salvato l'URL in <code>/roster/&lt;id&gt;</code>.</p>
    </section>

    <section class="card">
      <h2>Ordine Roster Roller</h2>
      <div class="tiny">Riordina con i pulsanti. Salva per applicare.</div>
      <div id="orderList" class="order" style="margin-top:8px;"></div>
      <div class="bar" style="margin-top:8px;">
        <button class="btn btn-accent" id="saveOrder">Salva ordine</button>
        <button class="btn" id="resetOrder">Reset ordine</button>
      </div>
    </section>

    <section class="card">
      <h2>Settaggi rapidi</h2>
      <div class="bar" style="flex-wrap:wrap; gap:14px;">
        <div><label class="tiny">Durata Roller (ms)</label><input type="number" id="setRollerHold" value="4000" min="500" step="100"></div>
        <div><label class="tiny">Animazione IN Roller (ms)</label><input type="number" id="setRollerIn" value="600" min="200" step="50"></div>
        <div><label class="tiny">Animazione OUT Roller (ms)</label><input type="number" id="setRollerOut" value="520" min="200" step="50"></div>
        <div><label class="tiny">Durata Lineup (ms)</label><input type="number" id="setLineupTTL" value="5000" min="1000" step="250"></div>
        <div><label class="tiny">Durata Subs (ms)</label><input type="number" id="setSubsTTL" value="2000" min="500" step="100"></div>
        <div><label class="tiny">Durata Flash (ms)</label><input type="number" id="setFlashTTL" value="2000" min="500" step="100"></div>
        <div style="min-width:220px;"><label class="tiny">Velocità animazioni</label><input type="range" id="setSpeed" min="0.5" max="2" step="0.05" value="1"><div class="tiny" id="speedLabel">1.00×</div></div>
      </div>
      <div class="bar" style="margin-top:8px;">
        <button class="btn btn-accent" id="saveSettings">Salva settaggi</button>
        <button class="btn" id="loadSettings">Ricarica</button>
        <button class="btn btn-danger" id="resetSettings">Default</button>
      </div>
    </section>

    <section class="card" style="grid-column: 1 / span 2;">
      <h2>Immagini Fullscreen</h2>
      <div class="bar">
        <input type="url" id="fsUrl" placeholder="https://… (URL immagine)" />
        <button class="btn btn-accent" id="addFs">Aggiungi</button>
        <label class="tiny">Trasparenza (0–1)</label>
        <input type="range" id="fsOpacity" min="0" max="1" step="0.05" value="1" style="width:160px;">
        <button class="btn" id="clearFs">Nascondi fullscreen</button>
      </div>
      <div id="fsGrid" class="grid" style="margin-top:10px;"></div>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Inserisci la tua config
    const firebaseConfig = {
      apiKey: "AIzaSyAyVKKlQTXIuSzxrm_2mATvQR1QjUvtRA8",
      authDomain: "roster-dinamico-esordienti.firebaseapp.com",
      projectId: "roster-dinamico-esordienti",
      storageBucket: "roster-dinamico-esordienti.appspot.com",
      messagingSenderId: "6424935938",
      appId: "1:6424935938:web:97c30f6f758fafad9eb11b",
      databaseURL: "https://roster-dinamico-esordienti-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const $ = s => document.querySelector(s);

    const playersEl = $('#players');
    const orderList = $('#orderList');
    const fsGrid = $('#fsGrid'); const fsUrl = $('#fsUrl'); const fsOpacity = $('#fsOpacity');

    const setRollerHold = $('#setRollerHold');
    const setRollerIn = $('#setRollerIn');
    const setRollerOut = $('#setRollerOut');
    const setLineupTTL = $('#setLineupTTL');
    const setSubsTTL = $('#setSubsTTL');
    const setFlashTTL = $('#setFlashTTL');
    const setSpeed = $('#setSpeed');
    const speedLabel = $('#speedLabel');

    const playerName = $('#playerName');
    const playerId = $('#playerId');
    const playerFile = $('#playerFile');
    const playerUrl = $('#playerUrl');
    const uploadStatus = $('#uploadStatus');
    const uploadProgress = $('#uploadProgress');

    document.getElementById('btnRoller').onclick = triggerRoller;
    document.getElementById('btnLineup').onclick = sendLineup;
    document.getElementById('btnSubs').onclick = () => db.ref('/mode').set('subs');
    document.getElementById('btnStop').onclick = setIdle;
    document.getElementById('btnClearSel').onclick = clearSelection;
    document.getElementById('saveOrder').onclick = saveOrder;
    document.getElementById('resetOrder').onclick = resetOrder;
    document.getElementById('addFs').onclick = addFullscreen;
    document.getElementById('clearFs').onclick = () => db.ref('/fullscreen/show').set(null).then(()=>db.ref('/fullscreen/clear').set(true));
    document.getElementById('saveSettings').onclick = saveSettings;
    document.getElementById('loadSettings').onclick = loadSettings;
    document.getElementById('resetSettings').onclick = resetSettings;
    document.getElementById('uploadPlayer').onclick = uploadOrSavePlayer;
    document.getElementById('clearForm').onclick = () => { playerName.value=''; playerId.value=''; playerFile.value=''; playerUrl.value=''; setStatus(''); };

    let roster = {}; let rollerOrder = [];

    db.ref('/roster').on('value', snap => { roster = snap.val() || {}; renderRoster(roster); renderOrder(roster); });

    function renderRoster(r){
      playersEl.innerHTML='';
      Object.entries(r).forEach(([id,p]) => {
        const row = document.createElement('div');
        row.className = 'player';
        row.innerHTML =
          '<img src="'+(p.img||'')+'" alt="'+(p.name||'')+'">' +
          '<div><div class="name">'+(p.name||'')+'</div>' +
          '<label class="tiny"><input type="checkbox" data-id="'+id+'" class="pickLineup"> Includi in lineup</label>' +
          '<div class="tiny">ID: '+id+'</div></div>' +
          '<button class="btn" data-id="'+id+'" data-action="flash">Flash 2s</button>' +
          '<button class="btn" data-id="'+id+'" data-action="edit">Modifica</button>' +
          '<button class="btn btn-danger" data-id="'+id+'" data-action="delete">Elimina</button>';
        row.querySelector('[data-action="flash"]').onclick = () => flashPlayer(id);
        row.querySelector('[data-action="edit"]').onclick = () => fillForm(id, p);
        row.querySelector('[data-action="delete"]').onclick = () => deletePlayer(id, p);
        playersEl.appendChild(row);
      });
    }
    function fillForm(id, p){ playerId.value=id; playerName.value=p.name||''; playerUrl.value=p.img||''; playerFile.value=''; playerName.scrollIntoView({behavior:'smooth', block:'center'}); }

    async function uploadOrSavePlayer(){
      try{
        setStatus('Preparazione…'); uploadProgress.style.display='none'; uploadProgress.value=0;
        const name = (playerName.value||'').trim();
        let id = (playerId.value||'').trim();
        const url = (playerUrl.value||'').trim();
        const file = playerFile.files && playerFile.files[0];
        if (!name) { alert('Inserisci il nome del giocatore.'); return; }
        if (!id) { id = 'p_' + Date.now(); }
        let imgUrl = url;

        if (!imgUrl && file){
          const ext = (file.name.includes('.') ? file.name.split('.').pop() : 'jpg').toLowerCase();
          const path = 'players/'+id+'.'+ext;
          const ref = storage.ref().child(path);
          const meta = { contentType: file.type || 'image/jpeg', cacheControl: 'public,max-age=604800' };
          setStatus('Upload in corso…');
          uploadProgress.style.display='block';
          const task = ref.put(file, meta);
          await new Promise((resolve, reject) => {
            task.on('state_changed',
              (snap) => {
                const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
                uploadProgress.value = pct;
                setStatus('Upload: '+pct+'%');
              },
              (err) => reject(err),
              () => resolve()
            );
          });
          const snap = await ref.getMetadata(); // ensure exists
          const finalRef = storage.ref().child(snap.fullPath);
          imgUrl = await finalRef.getDownloadURL();
        }

        if (!imgUrl){ alert('Carica un file o inserisci un URL valido.'); return; }

        await db.ref('/roster/'+id).set({ name, img: imgUrl });
        setStatus('Giocatore salvato.'); alert('Giocatore salvato.');
        playerId.value = id;
      } catch(err){
        console.error(err);
        alert('Errore nel caricamento/salvataggio: ' + (err && err.message ? err.message : err));
        setStatus('Errore: ' + (err && err.message ? err.message : String(err)));
      } finally {
        setTimeout(()=>{ uploadProgress.style.display='none'; }, 800);
      }
    }

    async function deletePlayer(id, p){
      if (!confirm('Eliminare il giocatore "'+(p.name||id)+'"?')) return;
      await db.ref('/roster/'+id).set(null);
      try {
        const bucket = firebase.app().options.storageBucket;
        if (p.img && p.img.includes(bucket)) {
          const ref = storage.refFromURL(p.img);
          await ref.delete();
        }
      } catch(e){ console.warn('Delete storage skipped:', e); }
    }

    // Order
    async function renderOrder(r){
      orderList.innerHTML='';
      const snap = await db.ref('/roller/order').get();
      const saved = snap.exists() ? snap.val() : null;
      const arr = Array.isArray(saved) && saved.length ? saved.filter(id=>r[id]) : Object.keys(r);
      arr.forEach((id, idx) => {
        const p = r[id]; if (!p) return;
        const row = document.createElement('div');
        row.className = 'order-item';
        row.innerHTML =
          '<img src="'+(p.img||'')+'"><div class="name">'+(p.name||'')+'</div>' +
          '<button class="btn" data-idx="'+idx+'" data-act="up">↑</button>' +
          '<button class="btn" data-idx="'+idx+'" data-act="down">↓</button>';
        row.querySelector('[data-act="up"]').onclick = () => moveOrder(idx, -1, arr);
        row.querySelector('[data-act="down"]').onclick = () => moveOrder(idx, 1, arr);
        orderList.appendChild(row);
      });
      rollerOrder = arr;
    }
    function moveOrder(index, dir, arr){
      const j = index + dir; if (j<0 || j>=arr.length) return;
      [arr[index], arr[j]] = [arr[j], arr[index]];
      rollerOrder = arr; renderOrder(Object.fromEntries(Object.entries(roster)));
    }
    function saveOrder(){ db.ref('/roller/order').set(rollerOrder); alert('Ordine salvato.'); }
    function resetOrder(){ db.ref('/roller/order').set(Object.keys(roster)); renderOrder(roster); }

    // Settings
    setSpeed.oninput = () => { speedLabel.textContent = Number(setSpeed.value).toFixed(2) + '×'; };
    async function loadSettings(){
      const snap = await db.ref('/settings').get();
      const s = snap.exists() ? snap.val() : {};
      setRollerHold.value = s.rollerHoldMs ?? 4000;
      setRollerIn.value   = s.rollerInMs ?? 600;
      setRollerOut.value  = s.rollerOutMs ?? 520;
      setLineupTTL.value  = s.lineupTTL ?? 5000;
      setSubsTTL.value    = s.subsTTL ?? 2000;
      setFlashTTL.value   = s.flashTTL ?? 2000;
      setSpeed.value      = s.speed ?? 1.0;
      speedLabel.textContent = Number(setSpeed.value).toFixed(2) + '×';
    }
    async function saveSettings(){
      const s = {
        rollerHoldMs: clampInt(setRollerHold.value, 500, 20000, 4000),
        rollerInMs:   clampInt(setRollerIn.value,   200, 5000,  600),
        rollerOutMs:  clampInt(setRollerOut.value,  200, 5000,  520),
        lineupTTL:    clampInt(setLineupTTL.value, 1000, 60000, 5000),
        subsTTL:      clampInt(setSubsTTL.value,    500, 20000, 2000),
        flashTTL:     clampInt(setFlashTTL.value,   500, 20000, 2000),
        speed:        clampNum(setSpeed.value, 0.5, 2.0, 1.0)
      };
      await db.ref('/settings').set(s);
      alert('Settaggi salvati.');
    }
    function resetSettings(){
      setRollerHold.value = 4000; setRollerIn.value = 600; setRollerOut.value = 520;
      setLineupTTL.value = 5000; setSubsTTL.value = 2000; setFlashTTL.value = 2000;
      setSpeed.value = 1.0; speedLabel.textContent = '1.00×';
    }
    function clampInt(v, min, max, dflt){ v = parseInt(v,10); if (isNaN(v)) return dflt; return Math.max(min, Math.min(max, v)); }
    function clampNum(v, min, max, dflt){ v = Number(v); if (!isFinite(v)) return dflt; return Math.max(min, Math.min(max, v)); }

    // Overlay modes
    async function triggerRoller(){ await db.ref('/mode').set('roller'); await db.ref('/roller/start').set(Date.now()); }
    async function sendLineup(){
      const picks = Array.from(document.querySelectorAll('.pickLineup:checked')).map(el => el.getAttribute('data-id'));
      if (!picks.length) { alert('Seleziona almeno un giocatore.'); return; }
      const ttlSnap = await db.ref('/settings/lineupTTL').get();
      const ttl = ttlSnap.exists() ? ttlSnap.val() : 5000;
      await db.ref('/mode').set('lineup');
      await db.ref('/lineup/show').set({ playerIds: picks, ttl, nonce: Date.now() });
    }
    async function setIdle(){
      await db.ref('/mode').set('idle');
      await db.ref('/lineup/show').set(null);
      await db.ref('/flash/show').set(null);
      await db.ref('/roller/start').set(null);
      await db.ref('/subs/show').set(null);
      await db.ref('/fullscreen/show').set(null);
    }
    async function flashPlayer(playerId){
      const ttlSnap = await db.ref('/settings/flashTTL').get();
      const ttl = ttlSnap.exists() ? ttlSnap.val() : 2000;
      await db.ref('/mode').set('flash');
      await db.ref('/flash/show').set({ playerId, ttl, nonce: Date.now() });
    }
    function clearSelection(){ document.querySelectorAll('.pickLineup').forEach(el => el.checked=false); }

    // Fullscreen helpers
    db.ref('/fullscreen/list').on('value', snap => renderFsList(snap.val() || []));
    function renderFsList(list){
      fsGrid.innerHTML='';
      list.forEach((url, idx) => {
        const card = document.createElement('div');
        card.className='thumb';
        card.innerHTML =
          '<img src="'+url+'" alt="img'+idx+'">' +
          '<div class="bar">' +
            '<button class="btn btn-ok" data-i="'+idx+'" data-act="view">Visualizza</button>' +
            '<button class="btn btn-danger" data-i="'+idx+'" data-act="del">Cancella</button>' +
          '</div>';
        card.querySelector('[data-act="view"]').onclick = () => viewFullscreen(url);
        card.querySelector('[data-act="del"]').onclick  = () => deleteFullscreen(idx);
        fsGrid.appendChild(card);
      });
    }
    async function addFullscreen(){
      const url = fsUrl.value.trim();
      if (!url) { alert('Inserisci un URL immagine.'); return; }
      const snap = await db.ref('/fullscreen/list').get();
      const list = snap.exists() ? snap.val() : [];
      list.push(url);
      await db.ref('/fullscreen/list').set(list);
      fsUrl.value='';
    }
    async function deleteFullscreen(index){
      const snap = await db.ref('/fullscreen/list').get();
      const list = snap.exists() ? snap.val() : [];
      list.splice(index,1);
      await db.ref('/fullscreen/list').set(list);
    }
    async function viewFullscreen(url){
      const op = Math.max(0, Math.min(1, Number(fsOpacity.value || 1)));
      await db.ref('/fullscreen/show').set({ url, opacity: op, nonce: Date.now() });
    }

    function setStatus(txt){ uploadStatus.textContent = txt || ''; }
    window.addEventListener('error', (e)=>console.error('GlobalError:', e.error||e.message));
  </script>
</body>
</html>
